<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>solutions</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><h1 id="solutions">Solutions</h1>
<h2 id="exercise-1">Exercise 1</h2>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>chrome<span class="token punctuation">.</span>options <span class="token keyword">import</span> Options
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support<span class="token punctuation">.</span>ui <span class="token keyword">import</span> WebDriverWait
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>common<span class="token punctuation">.</span>by <span class="token keyword">import</span> By
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support <span class="token keyword">import</span> expected_conditions <span class="token keyword">as</span> EC
<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup
<span class="token keyword">from</span> pymongo <span class="token keyword">import</span> MongoClient

MAX_WAIT <span class="token operator">=</span> <span class="token number">10</span>

options <span class="token operator">=</span> Options<span class="token punctuation">(</span><span class="token punctuation">)</span>
options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--window-size=1366,768"</span><span class="token punctuation">)</span>
options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--disable-notifications"</span><span class="token punctuation">)</span>
driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>chrome_options<span class="token operator">=</span>options<span class="token punctuation">)</span>

<span class="token comment"># set up DB connection for saving results</span>
client <span class="token operator">=</span> MongoClient<span class="token punctuation">(</span><span class="token string">'mongodb://localhost:27017/'</span><span class="token punctuation">)</span>
db <span class="token operator">=</span> client<span class="token punctuation">[</span><span class="token string">'bip'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'gm_place'</span><span class="token punctuation">]</span>

<span class="token comment"># input file, containing a list of urls</span>
urls <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'places_gm.txt'</span><span class="token punctuation">)</span>

<span class="token comment"># iterate over the file and scrape data from each url</span>
<span class="token keyword">for</span> url <span class="token keyword">in</span> urls<span class="token punctuation">:</span>

    <span class="token comment"># get the page</span>
    driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>

    <span class="token comment"># wait for content to load</span>
    wait <span class="token operator">=</span> WebDriverWait<span class="token punctuation">(</span>driver<span class="token punctuation">,</span> MAX_WAIT<span class="token punctuation">)</span>
    wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>element_to_be_clickable<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>CSS_SELECTOR<span class="token punctuation">,</span> <span class="token string">'span.section-star-display'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># send the page extracted with Selenium to BeautifulSoap parser</span>
    response <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>driver<span class="token punctuation">.</span>page_source<span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span>

    <span class="token comment"># prepare a dictionary to store results</span>
    place <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment"># get place name</span>
    name <span class="token operator">=</span> response<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">'section-hero-header-title'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
    place<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> name

    <span class="token comment"># get number of reviews</span>
    n_reviews <span class="token operator">=</span> response<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">'widget-pane-link'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>

    <span class="token comment"># casting to correct type</span>
    n_reviews <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>n_reviews<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    place<span class="token punctuation">[</span><span class="token string">'review'</span><span class="token punctuation">]</span> <span class="token operator">=</span> n_reviews

    <span class="token comment"># get rating using a regular expression to find the correct class</span>
    overall_rating <span class="token operator">=</span> overall_rating <span class="token operator">=</span> response<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> 
						class_<span class="token operator">=</span><span class="token string">'section-star-display'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text

    <span class="token comment"># casting to correct type</span>
    overall_rating <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>overall_rating<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    place<span class="token punctuation">[</span><span class="token string">'rating'</span><span class="token punctuation">]</span> <span class="token operator">=</span> overall_rating

    <span class="token comment"># get address</span>
    complete_address <span class="token operator">=</span> response<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">'section-info-line'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
    place<span class="token punctuation">[</span><span class="token string">'address'</span><span class="token punctuation">]</span> <span class="token operator">=</span> complete_address<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># get type of place</span>
    <span class="token builtin">type</span> <span class="token operator">=</span> response<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">'section-rating-term'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
    place<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">type</span>

    <span class="token comment"># save result into MongoDB collection</span>
    db<span class="token punctuation">.</span>insert_one<span class="token punctuation">(</span>place<span class="token punctuation">)</span>

urls<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
driver<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
driver<span class="token punctuation">.</span>quit<span class="token punctuation">(</span><span class="token punctuation">)</span>
client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="exercise-2">Exercise 2</h2>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>chrome<span class="token punctuation">.</span>options <span class="token keyword">import</span> Options
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support<span class="token punctuation">.</span>ui <span class="token keyword">import</span> WebDriverWait
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>common<span class="token punctuation">.</span>by <span class="token keyword">import</span> By
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support <span class="token keyword">import</span> expected_conditions <span class="token keyword">as</span> EC
<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup
<span class="token keyword">import</span> time
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">from</span> pymongo <span class="token keyword">import</span> MongoClient
<span class="token keyword">from</span> pymongo<span class="token punctuation">.</span>errors <span class="token keyword">import</span> DuplicateKeyError

N_MAX <span class="token operator">=</span> <span class="token number">20</span>
MAX_WAIT <span class="token operator">=</span> <span class="token number">10</span>
MAX_SCROLLS <span class="token operator">=</span> <span class="token number">50</span>


<span class="token comment"># function to interact with Google Maps page using Selenium</span>
<span class="token keyword">def</span> <span class="token function">expand_review</span><span class="token punctuation">(</span>driver<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># use XPath to load complete reviews</span>
    links <span class="token operator">=</span> driver<span class="token punctuation">.</span>find_elements_by_xpath<span class="token punctuation">(</span><span class="token string">'//a[@class=\'section-expand-review blue-link\']'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> l <span class="token keyword">in</span> links<span class="token punctuation">:</span>
        l<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>


options <span class="token operator">=</span> Options<span class="token punctuation">(</span><span class="token punctuation">)</span>
options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--window-size=1366,768"</span><span class="token punctuation">)</span>
options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--disable-notifications"</span><span class="token punctuation">)</span>
driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>chrome_options<span class="token operator">=</span>options<span class="token punctuation">)</span>

<span class="token comment"># create collection</span>
client <span class="token operator">=</span> MongoClient<span class="token punctuation">(</span><span class="token string">'mongodb://localhost:27017/'</span><span class="token punctuation">)</span>
db <span class="token operator">=</span> client<span class="token punctuation">[</span><span class="token string">'bip'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'gm_review'</span><span class="token punctuation">]</span>

<span class="token comment"># set unique identifier based on scraped data</span>
db<span class="token punctuation">.</span>create_index<span class="token punctuation">(</span><span class="token string">'id_review'</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

urls <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'places_gm.txt'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> url <span class="token keyword">in</span> urls<span class="token punctuation">:</span>

    <span class="token comment"># get first page of reviews and process</span>
    driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>

    wait <span class="token operator">=</span> WebDriverWait<span class="token punctuation">(</span>driver<span class="token punctuation">,</span> MAX_WAIT<span class="token punctuation">)</span>

    <span class="token comment"># go to review page</span>
    link_review <span class="token operator">=</span> wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>element_to_be_clickable<span class="token punctuation">(</span>
			    <span class="token punctuation">(</span>By<span class="token punctuation">.</span>CSS_SELECTOR<span class="token punctuation">,</span> <span class="token string">'button.widget-pane-link'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			    <span class="token punctuation">)</span><span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># wait to reviews container to load</span>
    reviews_container <span class="token operator">=</span> <span class="token string">'div.section-listbox.section-scrollbox.scrollable-y.scrollable-show'</span>
    wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>presence_of_element_located<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>CSS_SELECTOR<span class="token punctuation">,</span> reviews_container<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># load reviews and count to reach the requested number</span>
    n_reviews_loaded <span class="token operator">=</span> 
    content_div <span class="token operator">=</span> <span class="token string">'div.section-review-content'</span> 
	<span class="token builtin">len</span><span class="token punctuation">(</span>driver<span class="token punctuation">.</span>find_elements_by_css_selector<span class="token punctuation">(</span>content_div<span class="token punctuation">)</span><span class="token punctuation">)</span>
    n_scrolls <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> n_reviews_loaded <span class="token operator">&lt;</span> N_MAX <span class="token operator">and</span> n_scrolls <span class="token operator">&lt;</span> MAX_SCROLLS<span class="token punctuation">:</span>

        <span class="token comment"># get div container of reviews</span>
        scrollable_div <span class="token operator">=</span> driver<span class="token punctuation">.</span>find_element_by_css_selector<span class="token punctuation">(</span>reviews_container<span class="token punctuation">)</span>

        <span class="token comment"># scroll div to trigger reviews loading</span>
        driver<span class="token punctuation">.</span>execute_script<span class="token punctuation">(</span>
        <span class="token string">'arguments[0].scrollTop = arguments[0].scrollHeight'</span><span class="token punctuation">,</span> scrollable_div
        <span class="token punctuation">)</span>
        <span class="token comment"># wait for reviews to load</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

        <span class="token comment"># expand reviews</span>
        expand_review<span class="token punctuation">(</span>driver<span class="token punctuation">)</span>

        <span class="token comment"># count reviews to check if enough</span>
        n_reviews_loaded <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>driver<span class="token punctuation">.</span>find_elements_by_css_selector<span class="token punctuation">(</span>content_div<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> n_reviews_loaded

        n_scrolls <span class="token operator">+=</span> <span class="token number">1</span>

    <span class="token comment"># parse loaded reviews with BeautifulSoup</span>
    response <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>driver<span class="token punctuation">.</span>page_source<span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span>
    reviews <span class="token operator">=</span> response<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">'section-review-content'</span><span class="token punctuation">)</span>
    count <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> review <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>reviews<span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token comment"># get review id</span>
        id_review <span class="token operator">=</span> review<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> 
				   class_<span class="token operator">=</span><span class="token string">'section-review-action-menu'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'data-review-id'</span><span class="token punctuation">]</span>

        <span class="token comment"># get review date</span>
        review_date <span class="token operator">=</span> review<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> 
				class_<span class="token operator">=</span><span class="token string">'section-review-publish-date'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>

        <span class="token comment"># get reviewer information</span>
        <span class="token comment"># username</span>
        username <span class="token operator">=</span> review<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> 
		        class_<span class="token operator">=</span><span class="token string">'section-review-title'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>

        <span class="token comment"># number of reviewer photos</span>
        n_reviews_photos <span class="token operator">=</span> review<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> 
		  class_<span class="token operator">=</span><span class="token string">'section-review-subtitle'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        metadata <span class="token operator">=</span> n_reviews_photos<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\xe3\x83\xbb'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
            n_photos <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>metadata<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            n_photos <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token comment"># number of reviews</span>
        idx <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span>
        n_reviews <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>metadata<span class="token punctuation">[</span>idx<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># get rating of review</span>
        rating_raw <span class="token operator">=</span> review<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">'section-review-stars'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'aria-label'</span><span class="token punctuation">]</span>
        rating_review <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>rating_raw<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># get review complete text</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            caption <span class="token operator">=</span> review<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">'section-review-text'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token comment"># print e</span>
            caption <span class="token operator">=</span> <span class="token boolean">None</span>

        <span class="token comment"># build review item</span>
        item <span class="token operator">=</span> <span class="token punctuation">{</span>

            <span class="token string">'id_review'</span><span class="token punctuation">:</span> id_review<span class="token punctuation">,</span>
            <span class="token string">'caption'</span><span class="token punctuation">:</span> caption<span class="token punctuation">,</span>
            <span class="token string">'date'</span><span class="token punctuation">:</span> review_date<span class="token punctuation">,</span>
            <span class="token string">'rating'</span><span class="token punctuation">:</span> rating_review<span class="token punctuation">,</span>
            <span class="token string">'username'</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span>
            <span class="token string">'n_review_user'</span><span class="token punctuation">:</span> n_reviews<span class="token punctuation">,</span>
            <span class="token string">'n_photo_user'</span><span class="token punctuation">:</span> n_photos<span class="token punctuation">,</span>
            <span class="token string">'timestamp'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            db<span class="token punctuation">.</span>insert_one<span class="token punctuation">(</span>item<span class="token punctuation">)</span>
            count <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">except</span> DuplicateKeyError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span>

    <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">'Inserted {} new reviews'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># close resources</span>
urls<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
driver<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
driver<span class="token punctuation">.</span>quit<span class="token punctuation">(</span><span class="token punctuation">)</span>
client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="exercise-3">Exercise 3</h2>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>chrome<span class="token punctuation">.</span>options <span class="token keyword">import</span> Options
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support<span class="token punctuation">.</span>ui <span class="token keyword">import</span> WebDriverWait
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>common<span class="token punctuation">.</span>by <span class="token keyword">import</span> By
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support <span class="token keyword">import</span> expected_conditions <span class="token keyword">as</span> EC
<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup
<span class="token keyword">import</span> time
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">from</span> pymongo <span class="token keyword">import</span> MongoClient
<span class="token keyword">from</span> pymongo<span class="token punctuation">.</span>errors <span class="token keyword">import</span> DuplicateKeyError

N_MAX <span class="token operator">=</span> <span class="token number">20</span>
MAX_WAIT <span class="token operator">=</span> <span class="token number">10</span>
MAX_SCROLLS <span class="token operator">=</span> <span class="token number">50</span>


<span class="token comment"># function to interact with Google Maps page using Selenium</span>
<span class="token keyword">def</span> <span class="token function">expand_review</span><span class="token punctuation">(</span>driver<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># use XPath to load complete reviews</span>
    links <span class="token operator">=</span> driver<span class="token punctuation">.</span>find_elements_by_xpath<span class="token punctuation">(</span><span class="token string">'//a[@class=\'section-expand-review blue-link\']'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> l <span class="token keyword">in</span> links<span class="token punctuation">:</span>
        l<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>


options <span class="token operator">=</span> Options<span class="token punctuation">(</span><span class="token punctuation">)</span>
options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--window-size=1366,768"</span><span class="token punctuation">)</span>
options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--disable-notifications"</span><span class="token punctuation">)</span>
driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>chrome_options<span class="token operator">=</span>options<span class="token punctuation">)</span>

<span class="token comment"># create collection</span>
client <span class="token operator">=</span> MongoClient<span class="token punctuation">(</span><span class="token string">'mongodb://localhost:27017/'</span><span class="token punctuation">)</span>
db <span class="token operator">=</span> client<span class="token punctuation">[</span><span class="token string">'bip'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'gm_review'</span><span class="token punctuation">]</span>

<span class="token comment"># set unique identifier based on scraped data</span>
db<span class="token punctuation">.</span>create_index<span class="token punctuation">(</span><span class="token string">'id_review'</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

urls <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'places_gm.txt'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> url <span class="token keyword">in</span> urls<span class="token punctuation">:</span>

    <span class="token comment"># get first page of reviews and process</span>
    driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>

    wait <span class="token operator">=</span> WebDriverWait<span class="token punctuation">(</span>driver<span class="token punctuation">,</span> MAX_WAIT<span class="token punctuation">)</span>

    <span class="token comment"># go to review page</span>
    link_review <span class="token operator">=</span> wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>element_to_be_clickable<span class="token punctuation">(</span>
				  <span class="token punctuation">(</span>By<span class="token punctuation">.</span>CSS_SELECTOR<span class="token punctuation">,</span> <span class="token string">'button.widget-pane-link'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			    <span class="token punctuation">)</span><span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># wait to menu to load</span>
    menu_div <span class="token operator">=</span> <span class="token string">'button.section-tab-info-stats-button.section-tab-info-stats-right'</span>
    menu_bt <span class="token operator">=</span> wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>element_to_be_clickable<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>CSS_SELECTOR<span class="token punctuation">,</span> menu_div<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    clicked <span class="token operator">=</span> <span class="token boolean">False</span>
    tries <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> <span class="token operator">not</span> clicked<span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            menu_bt<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>
            top_rating_bt <span class="token operator">=</span> driver<span class="token punctuation">.</span>find_elements_by_xpath<span class="token punctuation">(</span><span class="token string">'//div[@role=\'menuitem\']'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
            top_rating_bt<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>

            clicked <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            tries <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword">print</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span>

    <span class="token comment"># wait reviews to load</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

    <span class="token comment"># count loaded reviews to reach the requested number</span>
    n_reviews_loaded <span class="token operator">=</span>
    content_div <span class="token operator">=</span> <span class="token string">'div.section-review-content'</span> 
    <span class="token builtin">len</span><span class="token punctuation">(</span>driver<span class="token punctuation">.</span>find_elements_by_css_selector<span class="token punctuation">(</span>content_div<span class="token punctuation">)</span><span class="token punctuation">)</span>
    reviews_container <span class="token operator">=</span> <span class="token string">'div.section-listbox.section-scrollbox.scrollable-y.scrollable-show'</span>
    n_scrolls <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> n_reviews_loaded <span class="token operator">&lt;</span> N_MAX <span class="token operator">and</span> n_scrolls <span class="token operator">&lt;</span> MAX_SCROLLS<span class="token punctuation">:</span>

        <span class="token comment"># get div container of reviews</span>
        scrollable_div <span class="token operator">=</span> driver<span class="token punctuation">.</span>find_element_by_css_selector<span class="token punctuation">(</span>reviews_container<span class="token punctuation">)</span>

        <span class="token comment"># scroll div to trigger reviews loading</span>
        driver<span class="token punctuation">.</span>execute_script<span class="token punctuation">(</span>
        <span class="token string">'arguments[0].scrollTop = arguments[0].scrollHeight'</span><span class="token punctuation">,</span> scrollable_div
        <span class="token punctuation">)</span>

        <span class="token comment"># wait for reviews to load</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

        <span class="token comment"># expand reviews</span>
        expand_review<span class="token punctuation">(</span>driver<span class="token punctuation">)</span>

        <span class="token comment"># count reviews to check if enough</span>
        n_reviews_loaded <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>driver<span class="token punctuation">.</span>find_elements_by_css_selector<span class="token punctuation">(</span>content_div<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> n_reviews_loaded

        n_scrolls <span class="token operator">+=</span> <span class="token number">1</span>

    <span class="token comment"># parse loaded reviews with BeautifulSoup</span>
    response <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>driver<span class="token punctuation">.</span>page_source<span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span>
    reviews <span class="token operator">=</span> response<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">'section-review-content'</span><span class="token punctuation">)</span>
    count <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> review <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>reviews<span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token comment"># get review id</span>
        id_review <span class="token operator">=</span> review<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span>
			    class_<span class="token operator">=</span><span class="token string">'section-review-action-menu'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'data-review-id'</span><span class="token punctuation">]</span>

        <span class="token comment"># get review date</span>
        review_date <span class="token operator">=</span> review<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> 
			  class_<span class="token operator">=</span><span class="token string">'section-review-publish-date'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>

        <span class="token comment"># get reviewer information</span>
        <span class="token comment"># username</span>
        username <span class="token operator">=</span> review<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> 
			  class_<span class="token operator">=</span><span class="token string">'section-review-title'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>

        <span class="token comment"># number of reviewer photos</span>
        n_reviews_photos <span class="token operator">=</span> review<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> 
		 class_<span class="token operator">=</span><span class="token string">'section-review-subtitle'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        metadata <span class="token operator">=</span> n_reviews_photos<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\xe3\x83\xbb'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
            n_photos <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>metadata<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            n_photos <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token comment"># number of reviews</span>
        idx <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span>
        n_reviews <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>metadata<span class="token punctuation">[</span>idx<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># get rating of review</span>
        rating_raw <span class="token operator">=</span> review<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">'section-review-stars'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'aria-label'</span><span class="token punctuation">]</span>
        rating_review <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>rating_raw<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># get review complete text</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            caption <span class="token operator">=</span> review<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">'section-review-text'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token comment"># print e</span>
            caption <span class="token operator">=</span> <span class="token boolean">None</span>

        <span class="token comment"># build review item</span>
        item <span class="token operator">=</span> <span class="token punctuation">{</span>

            <span class="token string">'id_review'</span><span class="token punctuation">:</span> id_review<span class="token punctuation">,</span>
            <span class="token string">'caption'</span><span class="token punctuation">:</span> caption<span class="token punctuation">,</span>
            <span class="token string">'date'</span><span class="token punctuation">:</span> review_date<span class="token punctuation">,</span>
            <span class="token string">'rating'</span><span class="token punctuation">:</span> rating_review<span class="token punctuation">,</span>
            <span class="token string">'username'</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span>
            <span class="token string">'n_review_user'</span><span class="token punctuation">:</span> n_reviews<span class="token punctuation">,</span>
            <span class="token string">'n_photo_user'</span><span class="token punctuation">:</span> n_photos<span class="token punctuation">,</span>
            <span class="token string">'timestamp'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            db<span class="token punctuation">.</span>insert_one<span class="token punctuation">(</span>item<span class="token punctuation">)</span>
            count <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">except</span> DuplicateKeyError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span>

    <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">'Inserted {} new reviews'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># close resources</span>
urls<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
driver<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
driver<span class="token punctuation">.</span>quit<span class="token punctuation">(</span><span class="token punctuation">)</span>
client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="exercise-4">Exercise 4</h2>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>chrome<span class="token punctuation">.</span>options <span class="token keyword">import</span> Options
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>common<span class="token punctuation">.</span>keys <span class="token keyword">import</span> Keys
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support<span class="token punctuation">.</span>ui <span class="token keyword">import</span> WebDriverWait
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>common<span class="token punctuation">.</span>by <span class="token keyword">import</span> By
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support <span class="token keyword">import</span> expected_conditions <span class="token keyword">as</span> EC
<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup
<span class="token keyword">from</span> pymongo <span class="token keyword">import</span> MongoClient
<span class="token keyword">from</span> pymongo<span class="token punctuation">.</span>errors <span class="token keyword">import</span> DuplicateKeyError

MAX_WAIT <span class="token operator">=</span> <span class="token number">10</span>


<span class="token keyword">def</span> <span class="token function">get_place_data</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># prepare a dictionary to store results</span>
    place <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment"># get place name</span>
    name <span class="token operator">=</span> response<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'h3'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">'section-result-title'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
    place<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> name<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># get number of reviews</span>
        n_reviews <span class="token operator">=</span> response<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">'section-result-num-ratings'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'aria-label'</span><span class="token punctuation">]</span>

        <span class="token comment"># casting to correct type or set to 0 if not present</span>
        n_reviews <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>n_reviews<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        n_reviews <span class="token operator">=</span> <span class="token number">0</span>

    place<span class="token punctuation">[</span><span class="token string">'review'</span><span class="token punctuation">]</span> <span class="token operator">=</span> n_reviews

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># get rating using a regular expression to find the correct class</span>
        overall_rating <span class="token operator">=</span> response<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">'cards-rating-score'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text

        <span class="token comment"># casting to correct type</span>
        overall_rating <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>overall_rating<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        overall_rating <span class="token operator">=</span> <span class="token number">0.0</span>

    place<span class="token punctuation">[</span><span class="token string">'rating'</span><span class="token punctuation">]</span> <span class="token operator">=</span> overall_rating

    <span class="token comment"># get address</span>
    complete_address <span class="token operator">=</span> response<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">'section-result-location'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
    place<span class="token punctuation">[</span><span class="token string">'address'</span><span class="token punctuation">]</span> <span class="token operator">=</span> complete_address<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># get type of place</span>
    <span class="token builtin">type</span> <span class="token operator">=</span> response<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">'section-result-details'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
    place<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">type</span>

    <span class="token keyword">return</span> place


options <span class="token operator">=</span> Options<span class="token punctuation">(</span><span class="token punctuation">)</span>
options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--window-size=1366,768"</span><span class="token punctuation">)</span>
options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--disable-notifications"</span><span class="token punctuation">)</span>
driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>chrome_options<span class="token operator">=</span>options<span class="token punctuation">)</span>

<span class="token comment"># create collection using scraped id as unique identifier</span>
client <span class="token operator">=</span> MongoClient<span class="token punctuation">(</span><span class="token string">'mongodb://localhost:27017/'</span><span class="token punctuation">)</span>
db <span class="token operator">=</span> client<span class="token punctuation">[</span><span class="token string">'bip'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'gm_place'</span><span class="token punctuation">]</span>
db<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># get main page and refresh because of pop-up</span>
webpage <span class="token operator">=</span> <span class="token string">'https://www.google.it/maps'</span>
driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span>webpage<span class="token punctuation">)</span>

<span class="token comment"># define a string query and start the search</span>
<span class="token comment"># NOTE: Google Maps check browser geolocalization</span>
query <span class="token operator">=</span> <span class="token string">'bar'</span>
search_bar <span class="token operator">=</span> driver<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">'searchboxinput'</span><span class="token punctuation">)</span>
search_bar<span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span>query<span class="token punctuation">)</span>
search_bar<span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span>Keys<span class="token punctuation">.</span>RETURN<span class="token punctuation">)</span>

<span class="token comment"># wait for search results to load</span>
wait <span class="token operator">=</span> WebDriverWait<span class="token punctuation">(</span>driver<span class="token punctuation">,</span> MAX_WAIT<span class="token punctuation">)</span>
wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>element_to_be_clickable<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>CSS_SELECTOR<span class="token punctuation">,</span> <span class="token string">'div.section-compact-filters'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># parse fully loaded page</span>
response <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>driver<span class="token punctuation">.</span>page_source<span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span>

place_list <span class="token operator">=</span> response<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">'section-result-content'</span><span class="token punctuation">)</span>

<span class="token comment"># scrape data from search results</span>
<span class="token keyword">for</span> place <span class="token keyword">in</span> place_list<span class="token punctuation">:</span>
    p <span class="token operator">=</span> get_place_data<span class="token punctuation">(</span>place<span class="token punctuation">)</span>
    db<span class="token punctuation">.</span>insert_one<span class="token punctuation">(</span>p<span class="token punctuation">)</span>

<span class="token comment"># close driver and quit</span>
driver<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
driver<span class="token punctuation">.</span>quit<span class="token punctuation">(</span><span class="token punctuation">)</span>
client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
</div>
</body>

</html>
